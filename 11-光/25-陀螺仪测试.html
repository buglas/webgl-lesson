<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ÈôÄËû∫‰ª™</title>
  <style>
    html {
      height: 100%;
    }

    body {
      margin: 0;
      height: 100%;
      overflow: hidden
    }

    .wrapper {
      display: flex;
      position: absolute;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      top: 0;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 10;
    }

    #playBtn {
      padding: 24px 24px;
      border-radius: 24px;
      background-color: #00acec;
      text-align: center;
      color: #fff;
      cursor: pointer;
      font-size: 24px;
      font-weight: bold;
      border: 6px solid rgba(255, 255, 255, 0.7);
      box-shadow: 0 9px 9px rgba(0, 0, 0, 0.7);
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <div class="wrapper">
    <div id="playBtn">ÂºÄÂêØVR‰πãÊóÖ</div>
  </div>
  <script id="vs" type="x-shader/x-vertex">
    attribute vec4 a_Position;
    attribute vec2 a_Pin;
    uniform mat4 u_PvMatrix;
    uniform mat4 u_ModelMatrix;
    varying vec2 v_Pin;
    void main(){
      gl_Position=u_PvMatrix*u_ModelMatrix*a_Position;
      v_Pin=a_Pin;
    }
  </script>
  <script id="fs" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D u_Sampler;
    varying vec2 v_Pin;
    void main(){
      gl_FragColor=texture2D(u_Sampler,v_Pin);
    }
  </script>
  <script type="module">
    import { createProgram, } from "/jsm/Utils.js";
    import {
      Matrix4, PerspectiveCamera, Vector3, Euler
    } from 'https://unpkg.com/three/build/three.module.js';
    import OrbitControls from './lv/OrbitControls.js'
    import Mat from './lv/Mat.js'
    import Geo from './lv/Geo.js'
    import Obj3D from './lv/Obj3D.js'
    import Scene from './lv/Scene.js'
    import Box from './lv/Box.js'

    const canvas = document.getElementById('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let gl = canvas.getContext('webgl');

    //Á´ãÊñπ‰Ωì
    const box = new Box(1, 1, 1)

    // ÁõÆÊ†áÁÇπ
    const target = new Vector3()
    //ËßÜÁÇπ
    const eye = new Vector3(0, 0.45, 0.0001)
    const [fov, aspect, near, far] = [
      120, canvas.width / canvas.height,
      0.1, 5
    ]
    // ÈÄèËßÜÁõ∏Êú∫
    const camera = new PerspectiveCamera(fov, aspect, near, far)
    camera.position.copy(eye)
    // ËΩ®ÈÅìÊéßÂà∂Âô®
    const orbit = new OrbitControls({
      camera,
      target,
      dom: canvas,
      enablePan: false,
      maxZoom: 15,
      minZoom: 0.4
    })

    // Âú∫ÊôØ
    const scene = new Scene({ gl })
    //Ê≥®ÂÜåÁ®ãÂ∫èÂØπË±°
    scene.registerProgram(
      'map',
      {
        program: createProgram(
          gl,
          document.getElementById('vs').innerText,
          document.getElementById('fs').innerText,
        ),
        attributeNames: ['a_Position', 'a_Pin'],
        uniformNames: ['u_PvMatrix', 'u_ModelMatrix', 'u_Sampler']
      }
    )

    //Á´ãÊñπ‰Ωì
    const matBox = new Mat({
      program: 'map',
      data: {
        u_PvMatrix: {
          value: orbit.getPvMatrix().elements,
          type: 'uniformMatrix4fv',
        },
        u_ModelMatrix: {
          value: new Matrix4().elements,
          type: 'uniformMatrix4fv',
        },
      },
    })
    const geoBox = new Geo({
      data: {
        a_Position: {
          array: box.vertices,
          size: 3
        },
        a_Pin: {
          array: box.uv,
          size: 2
        }
      },
      index: {
        array: box.indexes
      }
    })

    //Âä†ËΩΩÂõæÁâá
    const image = new Image()
    image.src = './images/magic.jpg'
    image.onload = function () {
      matBox.maps.u_Sampler = { image }
      scene.add(new Obj3D({
        geo: geoBox,
        mat: matBox
      }))
      render()
    }


    // ÈÅÆÁΩ©
    const wrapper = document.querySelector('.wrapper')
    //ÊåâÈíÆ
    const btn = document.querySelector('#playBtn')
    // Âà§Êñ≠ËÆæÂ§á‰∏≠ÊòØÂê¶ÊúâÈôÄËû∫‰ª™
    if (window.DeviceMotionEvent) {
      // ËÆ©Áî®Êà∑Ëß¶ÂèëÈôÄËû∫‰ª™ÁöÑÁõëÂê¨‰∫ã‰ª∂
      btn.addEventListener('click', () => {
        //Ëã•ÊòØiosÁ≥ªÁªüÔºåÈúÄË¶ÅËØ∑Ê±ÇÁî®Êà∑ËÆ∏ÂèØ
        if (DeviceMotionEvent.requestPermission) {
          //ËØ∑Ê±ÇÁî®Êà∑ËÆ∏ÂèØ
          requestPermission()
        } else {
          rotate()
        }
      })
    } else {
      btn.innerHTML = 'ÊÇ®ÁöÑËÆæÂ§áÈáåÊ≤°ÊúâÈôÄËû∫‰ª™ÔºÅ'
    }

    //ËØ∑Ê±ÇÁî®Êà∑ËÆ∏ÂèØ
    function requestPermission() {
      DeviceMotionEvent.requestPermission()
        .then((permissionState) => {
          if (permissionState === 'granted') {
            rotate()
          } else {
            btn.innerHTML = 'ËØ∑ÂÖÅËÆ∏‰ΩøÁî®ÈôÄËû∫‰ª™üåπ'
          }
        })
        .catch((err) => {
          btn.innerHTML = 'ËØ∑Ê±ÇÂ§±Ë¥•ÔºÅ'
        })
    }

    //ÁõëÂê¨ÈôÄËû∫‰ª™
    function rotate() {
      wrapper.style.display = 'none'
      window.addEventListener('deviceorientation', ({ alpha, beta, gamma }) => {
        const rad = Math.PI / 180
        const euler = new Euler(
          beta * rad,
          alpha * rad,
          -gamma * rad,
          'YXZ'
        )
        camera.position.copy(
          eye.clone().applyEuler(euler)
        )
        orbit.updateCamera()
        orbit.resetSpherical()
      })
    }

    function render() {
      orbit.getPvMatrix()
      scene.draw()
      requestAnimationFrame(render)
    }





    /* ÂèñÊ∂àÂè≥ÂáªËèúÂçïÁöÑÊòæÁ§∫ */
    canvas.addEventListener('contextmenu', event => {
      event.preventDefault()
    })
    /* ÊåáÈíàÊåâ‰∏ãÊó∂ÔºåËÆæÁΩÆÊãñÊãΩËµ∑Âßã‰ΩçÔºåËé∑ÂèñËΩ®ÈÅìÊéßÂà∂Âô®Áä∂ÊÄÅ„ÄÇ */
    canvas.addEventListener('pointerdown', event => {
      orbit.pointerdown(event)
    })
    /* ÊåáÈíàÁßªÂä®Êó∂ÔºåËã•ÊéßÂà∂Âô®Â§Ñ‰∫éÂπ≥ÁßªÁä∂ÊÄÅÔºåÂπ≥ÁßªÁõ∏Êú∫ÔºõËã•ÊéßÂà∂Âô®Â§Ñ‰∫éÊóãËΩ¨Áä∂ÊÄÅÔºåÊóãËΩ¨Áõ∏Êú∫„ÄÇ */
    canvas.addEventListener('pointermove', event => {
      orbit.pointermove(event)
    })
    /* ÊåáÈíàÊä¨Ëµ∑ */
    canvas.addEventListener('pointerup', event => {
      orbit.pointerup(event)
    })
    /* ÊªöËΩÆ‰∫ã‰ª∂ */
    canvas.addEventListener('wheel', event => {
      orbit.wheel(event, 'OrthographicCamera')
    })


  </script>
</body>

</html>